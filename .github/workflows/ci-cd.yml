name: Green+ CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # –°–ë–û–†–ö–ê –ò –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4
      
    - name: ‚öôÔ∏è –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0'
        
    - name: üì¶ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: dotnet restore
      
    - name: üèóÔ∏è –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
      run: dotnet build --configuration Release --no-restore
      
    - name: üß™ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
      run: dotnet test --configuration Release --no-build --verbosity normal
      continue-on-error: true  # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã –ø–∞–¥–∞—é—Ç

  # –ü–†–û–í–ï–†–ö–ê –ö–ê–ß–ï–°–¢–í–ê –ö–û–î–ê
  code-quality:
    runs-on: ubuntu-latest
    needs: build-test
    
    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4
      
    - name: üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞
      run: |
        echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
        echo "–í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å SonarQube"

  # –°–û–ó–î–ê–ù–ò–ï –î–û–ö–ï–† –û–ë–†–ê–ó–ê
  docker-build:
    runs-on: ubuntu-latest
    needs: code-quality
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
    
    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4
      
    - name: üê≥ –°–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑
      run: |
        echo "üê≥ –°–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑ –¥–ª—è Green+"
        echo "–•—ç—à –∫–æ–º–º–∏—Ç–∞: ${{ github.sha }}"
        echo "–í–µ—Ç–∫–∞: ${{ github.ref }}"

  # –î–ï–ü–õ–û–ô –ù–ê STAGING
  deploy-staging:
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - name: üöÄ –î–µ–ø–ª–æ–∏–º –Ω–∞ Staging
      run: |
        echo "üéØ –î–ï–ü–õ–û–ô –ù–ê STAGING –°–ï–†–í–ï–†"
        echo "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!"
        echo "URL: https://staging.greenplus.example.com"

  # –î–ï–ü–õ–û–ô –ù–ê PRODUCTION
  deploy-production:
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ‚è≥ –û–∂–∏–¥–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
      run: |
        echo "üëÄ –¢–†–ï–ë–£–ï–¢–°–Ø –†–£–ß–ù–û–ï –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï"
        echo "–î–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ Production –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"
        
    - name: üöÄ –î–µ–ø–ª–æ–∏–º –Ω–∞ Production
      run: |
        echo "üéâ –í–´–ü–û–õ–ù–Ø–ï–ú –î–ï–ü–õ–û–ô –ù–ê PRODUCTION!"
        echo "Green+ —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º!"
        echo "URL: https://greenplus.kz"
